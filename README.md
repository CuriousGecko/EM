# Система аутентификации и авторизации
Проект реализовывает контроль доступа через сессии и наборы правил для ролей с 
минимальным использованием возможностей фреймворков.

## Логика работы
Роли пользователей связываются с бизнес-объектами (пользователи, продукты и т.д.) 
через таблицу правил. В таблице определяются возможные действия над объектами 
(своими и чужими).

Схема запросов выглядит следующим образом:

* **request** → 
* **middleware** (устанавливает в **request** объект пользователя или 
* GuestUser, если не удалось найти валидную сессию пользователя) → 
* Декоратор **check_access** над **view** проводит проверки:
    * Вернет **405**, если метод не разрешен.
    * **401**, если не удалось определить пользователя (проверка опциональна).
    * **403**, если не найдена запись в таблице правил для роли пользователя 
      (в ином случае она кладется в request.access_rules). Проверка 
      опциональна. →
* **view**

Теперь во **view** мы имеем доступ к объекту пользователя/гостя и набору правил
для его роли. Фрагмент кода для наглядности:

```python
@check_access(
    allowed_methods=['GET'],          # Разрешен только GET метод
    get_rules_for='user',             # Получаем правила для ресурса 'user'
)
def get_user_list(request: HttpRequest) -> JsonResponse:
    """Выдаст список всех пользователей или вернет текущего."""
    
    # Проверяем право на чтение всех пользователей
    if request.access_rules.can_read_all:
        users = User.objects.filter(is_active=True)
        data = UserSerializer(users, many=True).data
        return JsonResponse({'users': data})
    else:
        # Если нет прав на всех - возвращаем только текущего пользователя
        data = UserSerializer(request.user).data
        return JsonResponse({'users': [data]})
```
Также для удобной проверки доступа к конкретному объекту реализована утилита
**check_object_access**. Выбрасываемые ею исключения **ObjectAccessDeniedError**
будут перехвачены **middleware** и возвращены в качестве ответа **403**.

## Примеры запросов ##
Регистрация пользователя: POST api/users/register/

```json
{
    "email": "user@example.com",
    "password": "securepassword123",
    "first_name": "Иван",
    "last_name": "Иванов",
    "patronymic": "Иванович"
}
```
Создание бизнес-элемента (админ): POST /api/access/business-elements/
```json

{
    "name": "product"
}
```
Получение mock-списка товаров: GET /mock/products/

## Стек технологий:
Django, DRF
